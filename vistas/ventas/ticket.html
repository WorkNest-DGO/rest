<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ticket de Venta</title>
    <style>
        body {
            width: 58mm;
            margin: 0 auto;
            font-family: Courier, monospace;
            font-size: 12px;
            text-align: center;
        }
        table {
            width: 100%;
        }
        #productos td {
            text-align: left;
        }
        #productos td:last-child {
            text-align: right;
        }
        #totalVenta {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 10px;
        }
        @media print {
            #btnImprimir {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="dividir" style="display:none;">
        <h2>Dividir venta</h2>
        <table id="tablaProductos" border="1">
            <thead>
                <tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Subcuenta</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <button id="agregarSub">Agregar subcuenta</button>
        <button id="guardarSub">Guardar Tickets</button>
        <div id="subcuentas"></div>
    </div>

    <div id="imprimir" style="display:none;">
        <h2 id="nombreRestaurante">Mi Restaurante</h2>
        <div id="fechaHora"></div>
        <div>Folio: <span id="folio"></span></div>
        <div>Venta: <span id="ventaId"></span></div>
        <table id="productos">
            <tbody></tbody>
        </table>
        <div id="propina"></div>
        <div id="totalVenta"></div>
        <p>Gracias por su compra</p>
        <button id="btnImprimir" onclick="window.print()">Imprimir</button>
    </div>

    <script>
        function llenarTicket(data) {
            document.getElementById('ventaId').textContent = data.venta_id;
            document.getElementById('fechaHora').textContent = data.fecha;
            document.getElementById('folio').textContent = data.folio || '';
            if (data.restaurante) {
                document.getElementById('nombreRestaurante').textContent = data.restaurante;
            }
            const tbody = document.querySelector('#productos tbody');
            tbody.innerHTML = '';
            data.productos.forEach(p => {
                const tr = document.createElement('tr');
                const subtotal = p.cantidad * p.precio_unitario;
                tr.innerHTML = `<td>${p.nombre}</td><td>${p.cantidad} x ${p.precio_unitario} = ${subtotal}</td>`;
                tbody.appendChild(tr);
            });
            if (typeof data.propina !== 'undefined') {
                document.getElementById('propina').textContent = 'Propina: $' + data.propina.toFixed(2);
            }
            document.getElementById('totalVenta').textContent = 'Total: $' + data.total;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const imprimir = params.get('print') === '1';
            const almacenado = localStorage.getItem('ticketData');
            if (!almacenado) return;
            const datos = JSON.parse(almacenado);
            if (imprimir) {
                document.getElementById('imprimir').style.display = 'block';
                llenarTicket(datos);
            } else {
                inicializarDividir(datos);
            }
        });

        let productos = [];
        let numSub = 1;
        let ticketsGuardados = [];

        function inicializarDividir(data) {
            document.getElementById('dividir').style.display = 'block';
            productos = data.productos.map(p => Object.assign({ subcuenta: 1 }, p));
            renderProductos();
            renderSubcuentas();
            document.getElementById('agregarSub').addEventListener('click', () => {
                numSub++;
                actualizarSelects();
                renderSubcuentas();
            });
            document.getElementById('guardarSub').addEventListener('click', guardarSubcuentas);
        }

        function renderProductos() {
            const tbody = document.querySelector('#tablaProductos tbody');
            tbody.innerHTML = '';
            productos.forEach(p => {
                const tr = document.createElement('tr');
                const sel = document.createElement('select');
                for (let i = 1; i <= numSub; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = i;
                    sel.appendChild(opt);
                }
                sel.value = p.subcuenta;
                sel.addEventListener('change', () => {
                    p.subcuenta = parseInt(sel.value);
                    renderSubcuentas();
                });
                tr.innerHTML = `<td>${p.nombre}</td><td>${p.cantidad}</td><td>${p.precio_unitario}</td>`;
                const td = document.createElement('td');
                td.appendChild(sel);
                tr.appendChild(td);
                tbody.appendChild(tr);
            });
        }

        function actualizarSelects() {
            document.querySelectorAll('#tablaProductos select').forEach(sel => {
                const val = sel.value;
                sel.innerHTML = '';
                for (let i = 1; i <= numSub; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = i;
                    sel.appendChild(opt);
                }
                sel.value = val;
            });
        }

        function renderSubcuentas() {
            const cont = document.getElementById('subcuentas');
            cont.innerHTML = '';
            for (let i = 1; i <= numSub; i++) {
                const div = document.createElement('div');
                div.id = 'sub' + i;
                const prods = productos.filter(p => p.subcuenta === i);
                let html = `<h3>Subcuenta ${i}</h3><table><tbody>`;
                prods.forEach(p => {
                    html += `<tr><td>${p.nombre}</td><td>${p.cantidad} x ${p.precio_unitario}</td></tr>`;
                });
                html += '</tbody></table>';
                html += `Propina: <input type="number" step="0.01" id="propina${i}" value="0"><div id="tot${i}"></div>`;
                div.innerHTML = html;
                cont.appendChild(div);
            }
            mostrarTotal();
        }

        function mostrarTotal() {
            for (let i = 1; i <= numSub; i++) {
                const prods = productos.filter(p => p.subcuenta === i);
                let total = prods.reduce((s, p) => s + p.cantidad * p.precio_unitario, 0);
                const prop = parseFloat(document.getElementById('propina' + i).value || 0);
                total += prop;
                document.getElementById('tot' + i).textContent = 'Total: ' + total.toFixed(2);
            }
        }

        function guardarSubcuentas() {
            const info = JSON.parse(localStorage.getItem('ticketData'));
            const payload = { venta_id: info.venta_id, usuario_id: info.usuario_id || 1, subcuentas: [] };
            for (let i = 1; i <= numSub; i++) {
                const prods = productos.filter(p => p.subcuenta === i).map(p => ({ producto_id: p.producto_id, cantidad: p.cantidad, precio_unitario: p.precio_unitario }));
                if (prods.length === 0) continue;
                const prop = parseFloat(document.getElementById('propina' + i).value || 0);
                payload.subcuentas.push({ productos: prods, propina: prop });
            }
            fetch('../../api/tickets/guardar_ticket.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        ticketsGuardados = d.resultado.tickets || [];
                        alert('Tickets guardados');
                        mostrarBotonesImprimir(payload);
                    } else {
                        alert(d.mensaje);
                    }
                })
                .catch(() => alert('Error al guardar'));
        }

        function mostrarBotonesImprimir(payload) {
            ticketsGuardados.forEach((t, i) => {
                const div = document.getElementById('sub' + (i + 1));
                if (!div) return;
                const btn = document.createElement('button');
                btn.textContent = 'Imprimir Ticket';
                btn.addEventListener('click', () => {
                    const prods = productos.filter(p => p.subcuenta === i + 1);
                    const data = {
                        venta_id: payload.venta_id,
                        folio: t.folio,
                        fecha: new Date().toLocaleString(),
                        productos: prods,
                        propina: t.propina,
                        total: t.total
                    };
                    localStorage.setItem('ticketData', JSON.stringify(data));
                    window.open('ticket.html?print=1', '_blank');
                });
                div.appendChild(btn);
            });
        }
    </script>
</body>
</html>
